<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Rachão Santa Casa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f4f5;
            --card-bg-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #eab308;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.05);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: #f9fafb;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #d99f07; }
        .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .modal { display: none; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.7); }
        .modal.is-open { display: flex; }
        .participant-list {
            height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .participant-item:hover {
            background-color: #f3f4f6;
        }
        .admin-menu-item {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .admin-menu-item:hover {
            background-color: #f3f4f6;
            color: var(--text-primary);
        }
        .admin-menu-item.active {
            background-color: var(--accent-color);
            color: white;
        }
        .accordion-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
         .accordion-content.hidden ~ .accordion-header .accordion-icon {
             transform: rotate(-90deg);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Tela de Login -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="card w-full max-w-sm">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo" class="w-48 mx-auto mb-6">
            <h2 class="text-2xl font-bold text-center mb-6">Acesso Restrito</h2>
            <form id="login-form" class="space-y-4">
                 <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                    <input type="password" id="password" class="input-field mt-1" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Painel Principal (escondido por padrão) -->
    <div id="dashboard-section" class="hidden max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold">Painel de Administração</h1>
            <button id="logout-btn" class="btn btn-secondary">Sair</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- Menu Lateral -->
            <div class="md:col-span-1">
                <div class="card p-4">
                    <ul id="admin-menu" class="space-y-1">
                        <li><a href="#" data-target="section-resultados" class="admin-menu-item"><i class="fas fa-trophy w-6 mr-2"></i>Resultados</a></li>
                        <li><a href="#" data-target="section-participantes" class="admin-menu-item"><i class="fas fa-users w-6 mr-2"></i>Participantes</a></li>
                        <li><a href="#" data-target="section-config" class="admin-menu-item"><i class="fas fa-cog w-6 mr-2"></i>Configurações</a></li>
                        <li><a href="#" data-target="section-logs" class="admin-menu-item"><i class="fas fa-clipboard-list w-6 mr-2"></i>Logs</a></li>
                    </ul>
                </div>
            </div>

            <!-- Área de Conteúdo -->
            <div class="md:col-span-3">
                
                <!-- Seção Gerir Resultados -->
                <div id="section-resultados" class="admin-section">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Resultados</h2>
                        <div class="flex flex-wrap gap-4 items-center mb-6">
                            <select id="month-select-admin" class="input-field flex-grow"></select>
                            <button id="new-month-btn" class="btn btn-secondary">Novo Mês</button>
                        </div>

                        <div id="results-form" class="space-y-2"></div>
                        <div class="mt-6 border-t pt-6">
                            <button id="add-stage-btn" class="btn btn-secondary w-full mb-4">Adicionar Nova Etapa</button>
                            <div class="space-y-4 my-4">
                                <div>
                                    <label for="geral_podium_img" class="font-medium text-sm">URL da Foto da Classificação Geral</label>
                                    <input type="url" id="geral_podium_img" class="input-field mt-1" placeholder="https://...">
                                </div>
                                <div>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="month-completed-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                                        <span class="font-medium">Mês Concluído (exibir pódio)</span>
                                    </label>
                                </div>
                            </div>
                            <button id="save-results-btn" class="btn btn-primary w-full">Guardar Alterações do Mês</button>
                        </div>
                    </div>
                </div>
                
                <!-- Seção Gerir Participantes -->
                <div id="section-participantes" class="admin-section hidden">
                     <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Participantes</h2>
                        <form id="add-participant-form" class="space-y-3 mb-6">
                            <input id="participant-name" type="text" placeholder="Nome" class="input-field" required>
                            <select id="participant-team" class="input-field"></select>
                            <div>
                                <label for="participant-image-filename" class="font-medium text-sm">Nome do Ficheiro da Foto</label>
                                <input id="participant-image-filename" type="text" placeholder="ex: joao.jpg" class="input-field mt-1">
                                <p class="text-xs text-gray-500 mt-1">O ficheiro deve estar na pasta configurada.</p>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Adicionar Participante</button>
                        </form>
                        <div id="participants-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Seção Configurações -->
                <div id="section-config" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Configurações Gerais</h2>
                        <div class="space-y-3">
                            <div>
                                <label for="image-base-url" class="font-medium text-sm">URL Base das Imagens</label>
                                <input id="image-base-url" type="url" placeholder="https://..." class="input-field mt-1">
                                <p class="text-xs text-gray-500 mt-1">Caminho da pasta onde as fotos estão guardadas (terminar com /).</p>
                            </div>
                            <button id="save-settings-btn" class="btn btn-primary w-full">Guardar Configurações</button>
                        </div>
                    </div>
                </div>
                
                <!-- Seção Logs -->
                <div id="section-logs" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Registro de Atividades (Logs)</h2>
                        <div id="logs-list" class="space-y-2 text-sm text-gray-600 max-h-[40rem] overflow-y-auto"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="edit-participant-modal" class="modal">
        <div class="card w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Editar Participante</h2>
                <button onclick="closeModal('edit-participant-modal')" class="text-2xl">&times;</button>
            </div>
            <form id="edit-participant-form" class="space-y-3">
                <input type="hidden" id="edit-participant-id">
                <div>
                    <label for="edit-participant-name" class="font-medium">Nome</label>
                    <input id="edit-participant-name" type="text" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="edit-participant-team" class="font-medium">Equipe</label>
                    <select id="edit-participant-team" class="input-field mt-1"></select>
                </div>
                <div id="team-change-options" class="hidden space-y-2 border-t pt-4">
                    <div>
                        <label for="transfer-date" class="font-medium text-sm">Data da Transferência/Correção</label>
                        <input id="transfer-date" type="date" class="input-field mt-1">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                             <input type="checkbox" id="correction-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                             <span class="text-sm">Apenas corrigir (alterar todo o histórico)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="edit-participant-image-filename" class="font-medium">Nome do Ficheiro da Foto</label>
                    <input id="edit-participant-image-filename" type="text" class="input-field mt-1" placeholder="ex: joao.jpg">
                     <p class="text-xs text-gray-500 mt-1">O ficheiro deve estar na pasta configurada.</p>
                </div>
                <div class="pt-2">
                    <label class="flex items-center gap-2">
                         <input type="checkbox" id="edit-participant-sporadic" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                         <span class="font-medium">Marcar como participante esporádico (não pontua)</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                     <button type="button" onclick="closeModal('edit-participant-modal')" class="btn btn-secondary">Cancelar</button>
                     <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-options-modal" class="modal">
        <div class="card w-full max-w-lg">
            <h2 class="text-xl font-bold mb-2">Como deseja remover <span id="delete-participant-name" class="text-yellow-600"></span>?</h2>
            <p class="text-gray-600 mb-6">Pode desativar o participante para o remover das listas, mas manter o seu histórico, ou excluí-lo permanentemente.</p>
            
            <div class="space-y-4">
                <div class="p-4 border rounded-lg">
                    <h3 class="font-semibold">Desativar Participante (Recomendado)</h3>
                    <p class="text-sm text-gray-500 mb-3">O participante será removido das listas de seleção, mas o seu nome e resultados históricos continuarão a aparecer nas classificações antigas.</p>
                    <button id="deactivate-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full">Desativar</button>
                </div>
                <div class="p-4 border rounded-lg border-red-200 bg-red-50">
                     <h3 class="font-semibold text-red-700">Excluir Permanente</h3>
                    <p class="text-sm text-gray-500 mb-3">O participante e todo o seu histórico de resultados serão apagados para sempre. Esta ação não pode ser desfeita.</p>
                    <button id="hard-delete-btn" class="btn bg-red-600 hover:bg-red-700 text-white w-full">Excluir Permanente</button>
                </div>
            </div>

            <div class="mt-6 text-center">
                 <button id="cancel-delete-options-btn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Universal Modals -->
    <div id="info-modal" class="modal">
        <div class="card w-full max-w-sm text-center">
            <p id="info-modal-text" class="mb-6"></p>
            <button id="info-modal-close" class="btn btn-primary">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="card w-full max-w-sm text-center">
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-modal-ok" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="modal">
        <div class="card w-full max-w-sm">
            <p id="prompt-modal-text" class="mb-4 font-medium"></p>
            <input id="prompt-modal-input" type="text" class="input-field mb-4">
            <div class="flex justify-end gap-4">
                <button id="prompt-modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="prompt-modal-ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, getDocs, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, arrayUnion, arrayRemove, addDoc, serverTimestamp, Timestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWsgx2mSOPwNwWBwl373DJ3oj7VuFwy9Y",
            authDomain: "rachaosc.firebaseapp.com",
            projectId: "rachaosc",
            storageBucket: "rachaosc.appspot.com",
            messagingSenderId: "28309536958",
            appId: "1:28309536958:web:eac51586cdabd82f691eef"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let participantsData = {};
        let nameToIdMap = {};
        let monthlyData = {};
        let sporadicRiders = [];
        let allTeams = new Set();
        let imageBaseUrl = '';
        let participantOriginalTeam = '';
        let dashboardInitialized = false;
        
        // --- Modal Logic ---
        function openInfoModal(text) {
            document.getElementById('info-modal-text').textContent = text;
            openModal('info-modal');
        }

        function openConfirmModal(text) {
            return new Promise((resolve) => {
                document.getElementById('confirm-modal-text').textContent = text;
                openModal('confirm-modal');
                document.getElementById('confirm-modal-ok').onclick = () => { closeModal('confirm-modal'); resolve(true); };
                document.getElementById('confirm-modal-cancel').onclick = () => { closeModal('confirm-modal'); resolve(false); };
            });
        }

        async function openPromptModal(text, defaultValue = '') {
            return new Promise((resolve) => {
                document.getElementById('prompt-modal-text').textContent = text;
                const input = document.getElementById('prompt-modal-input');
                input.value = defaultValue;
                openModal('prompt-modal');
                
                const okHandler = () => {
                    closeModal('prompt-modal');
                    resolve(input.value);
                };

                const cancelHandler = () => {
                    closeModal('prompt-modal');
                    resolve(null);
                };

                document.getElementById('prompt-modal-ok').onclick = okHandler;
                document.getElementById('prompt-modal-cancel').onclick = cancelHandler;
            });
        }
        // --- End Modal Logic ---

        async function logAction(action, details) {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, 'logs'), {
                    timestamp: serverTimestamp(),
                    adminEmail: auth.currentUser.email,
                    action: action,
                    details: details
                });
            } catch (error) {
                console.error("Erro ao gravar log:", error);
            }
        }

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            if (!dashboardInitialized) {
                setupDashboardEventListeners();
                dashboardInitialized = true;
            }
            loadAllData();
        }

        function showLogin() {
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('dashboard-section').style.display = 'none';
        }
        
        function openModal(id) { document.getElementById(id).classList.add('is-open'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('is-open'); }

        async function standardizeParticipantsData() {
            const pSnap = await getDocs(collection(db, "participants"));
            const batch = writeBatch(db);
            let needsMigration = false;

            pSnap.forEach(pDoc => {
                const p = pDoc.data();
                let updatedData = { ...p };
                let needsUpdate = false;

                if (typeof updatedData.isActive === 'undefined') {
                    updatedData.isActive = true;
                    needsUpdate = true;
                }
                if (!updatedData.createdAt) {
                    updatedData.createdAt = Timestamp.fromDate(new Date('2023-01-01T12:00:00Z'));
                    needsUpdate = true;
                }
                if ((!updatedData.teamHistory || updatedData.teamHistory.length === 0) && updatedData.team) {
                    const defaultDate = updatedData.createdAt?.toDate ? updatedData.createdAt.toDate().toISOString().split('T')[0] : '2023-01-01';
                    updatedData.teamHistory = [{ team: updatedData.team, date: defaultDate }];
                    needsUpdate = true;
                }
                if ('team' in updatedData) {
                    delete updatedData.team;
                    needsUpdate = true;
                }
                if (needsUpdate) {
                    needsMigration = true;
                    const pRef = doc(db, 'participants', pDoc.id);
                    batch.set(pRef, updatedData);
                }
            });

            if (needsMigration) {
                console.log("Padronizando estrutura de participantes...");
                await batch.commit();
                await logAction('DATA_MIGRATION', 'Estrutura de participantes foi padronizada automaticamente.');
                console.log("Padronização concluída.");
                return true;
            }
            return false;
        }


        async function loadAllData() {
            try {
                const standardized = await standardizeParticipantsData();
                if (standardized) {
                    console.log("Recarregando dados após padronização.");
                }

                const [pSnap, rSnap, settingsSnap, logsSnap] = await Promise.all([
                    getDocs(collection(db, "participants")),
                    getDocs(collection(db, "results")),
                    getDoc(doc(db, "settings", "config")),
                    getDocs(query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50)))
                ]);
                
                participantsData = {};
                nameToIdMap = {};
                pSnap.forEach(doc => {
                    const data = doc.data();
                    if (data && data.name) {
                        participantsData[doc.id] = data;
                        nameToIdMap[data.name.toUpperCase()] = doc.id;
                    }
                });
                
                monthlyData = {};
                rSnap.forEach(doc => {
                    monthlyData[doc.id] = doc.data();
                });

                if (settingsSnap.exists()) {
                    const settings = settingsSnap.data();
                    sporadicRiders = settings.sporadicRiders || [];
                    imageBaseUrl = settings.imageBaseUrl || '';
                    document.getElementById('image-base-url').value = imageBaseUrl;
                }
                
                allTeams.clear();
                Object.values(participantsData).forEach(p => {
                    (p.teamHistory || []).forEach(h => allTeams.add(h.team));
                });

                renderParticipants();
                renderMonthSelector();
                renderTeamSelectors();
                renderLogs(logsSnap);
                
                const initialMonth = document.getElementById('month-select-admin').value;
                if(initialMonth) renderResultsForm(initialMonth);

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                openInfoModal("Não foi possível carregar os dados do Firebase. Verifique a consola.");
            }
        }

        function renderTeamSelectors(newTeamToSelect = '') {
            const selects = [document.getElementById('participant-team'), document.getElementById('edit-participant-team')];
            const sortedTeams = [...allTeams].sort();

            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">Selecionar equipe</option>';
                sortedTeams.forEach(team => select.add(new Option(team, team)));
                select.add(new Option("--- Criar nova equipe ---", "new_team"));
                select.value = newTeamToSelect || currentValue || '';
            });
        }

        async function handleTeamSelection(selectElementId) {
            const select = document.getElementById(selectElementId);
            if (select.value === 'new_team') {
                const newTeam = await openPromptModal("Digite o nome da nova equipe:");
                if (newTeam && newTeam.trim()) {
                    const trimmedTeam = newTeam.trim();
                    allTeams.add(trimmedTeam);
                    renderTeamSelectors(trimmedTeam);
                } else {
                    select.value = '';
                }
            }
        }
        
        function renderLogs(logsSnap) {
            const list = document.getElementById('logs-list');
            list.innerHTML = '';
            if (logsSnap.empty) {
                list.innerHTML = '<p>Nenhuma atividade registrada.</p>';
                return;
            }
            logsSnap.forEach(doc => {
                const log = doc.data();
                const date = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('pt-BR') : 'Data inválida';
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-50 rounded-md border-l-4 border-gray-300';
                div.innerHTML = `
                    <p><strong class="font-semibold">${log.details}</strong></p>
                    <p class="text-xs text-gray-400">${log.adminEmail} em ${date}</p>
                `;
                list.appendChild(div);
            });
        }

        function renderParticipants() {
            const list = document.getElementById('participants-list');
            list.innerHTML = '';
            const sortedParticipants = Object.entries(participantsData)
                .filter(([id, p]) => p.isActive !== false)
                .sort((a, b) => a[1].name.localeCompare(b[1].name));

            sortedParticipants.forEach(([id, participant]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                const isSporadic = sporadicRiders.includes(id);
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${participant.name}</span>
                        ${isSporadic ? '<span class="ml-2 text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded-full">ESPORÁDICO</span>' : ''}
                    </div>
                    <div class="space-x-2">
                        <button class="text-blue-500 hover:text-blue-700" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500 hover:text-red-700" data-id="${id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        function renderMonthSelector() {
            const select = document.getElementById('month-select-admin');
            select.innerHTML = '';
            const allMonthIds = new Set(Object.keys(monthlyData));
            const currentDate = new Date();
            const currentMonthId = `${currentDate.getFullYear()}_${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            allMonthIds.add(currentMonthId);
            const sortedMonths = [...allMonthIds].sort().reverse();
            
            sortedMonths.forEach(id => {
                const title = monthlyData[id] ? monthlyData[id].title : `${id.split('_')[1]}/${id.split('_')[0]} (Novo)`;
                select.add(new Option(title, id));
            });
            select.value = currentMonthId;
        }
        
        function createStageFormHTML(stage, index, isOpen = false) {
            const stageId = stage.id || `new_stage_${index}`;
            const stageResultsIds = (stage.results || []).map(p => p.id || nameToIdMap[p.name?.toUpperCase()]).filter(Boolean);

            const availableParticipants = Object.entries(participantsData)
                .filter(([id, p]) => p.isActive !== false && !stageResultsIds.includes(id))
                .sort((a, b) => a[1].name.localeCompare(b[1].name));

            const availableParticipantsHtml = availableParticipants.map(([id, p]) => `
                <div class="participant-item available-participant" data-id="${id}" data-name="${p.name.toLowerCase()}">
                    <span>${p.name}</span>
                    <button type="button" class="text-green-500 hover:text-green-700 add-participant-to-stage-btn"><i class="fas fa-plus-circle"></i></button>
                </div>
            `).join('');
            
            const classifiedParticipantsHtml = stageResultsIds.map((id, idx) => {
                const p = participantsData[id];
                if (!p) return '';
                return `
                    <div class="participant-item classified-participant" data-id="${id}">
                        <span>${idx + 1}. ${p.name}</span>
                        <div class="space-x-2">
                            <button type="button" class="text-gray-500 hover:text-gray-700 move-up-btn"><i class="fas fa-arrow-up"></i></button>
                            <button type="button" class="text-gray-500 hover:text-gray-700 move-down-btn"><i class="fas fa-arrow-down"></i></button>
                            <button type="button" class="text-red-500 hover:text-red-700 remove-participant-from-stage-btn"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const hiddenClass = isOpen ? '' : 'hidden';

            return `
                <div class="stage-form-group border-t-2 border-dashed pt-4">
                    <div class="accordion-header bg-gray-50 rounded-t-lg p-4">
                         <h3 class="font-bold text-lg">${stage.name || `Etapa ${index + 1}`}</h3>
                         <i class="fas fa-chevron-down accordion-icon"></i>
                    </div>
                    <div class="accordion-content p-4 border border-t-0 rounded-b-lg ${hiddenClass}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" placeholder="Nome da Etapa" class="input-field stage-name" value="${stage.name || ''}">
                            <input type="date" class="input-field stage-date" value="${stage.date || ''}">
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                            <select class="input-field stage-type">
                                <option value="">Selecione o tipo</option>
                                <option value="Circuito" ${stage.type === 'Circuito' ? 'selected' : ''}>Circuito</option>
                                <option value="Estrada" ${stage.type === 'Estrada' ? 'selected' : ''}>Estrada</option>
                                <option value="Crono" ${stage.type === 'Crono' ? 'selected' : ''}>Crono</option>
                            </select>
                            <input type="text" placeholder="Duração/Distância" class="input-field stage-duration-distance" value="${stage.durationDistance || ''}">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label class="font-medium text-sm block mb-1">Participantes Disponíveis</label>
                                <input type="text" placeholder="Filtrar..." class="input-field mb-2 filter-available-participants">
                                <div class="participant-list available-list">${availableParticipantsHtml}</div>
                            </div>
                            <div>
                                <label class="font-medium text-sm block mb-1">Classificação da Etapa</label>
                                <div class="participant-list classified-list">${classifiedParticipantsHtml}</div>
                            </div>
                        </div>

                        <label class="font-medium text-sm mt-3 block">URL da Foto do Pódio</label>
                        <input type="url" class="input-field mt-1 stage-podium-img" value="${stage.podium_img || ''}">
                        <button type="button" class="btn-danger text-sm py-1 px-2 remove-stage-btn mt-4">Remover Etapa</button>
                    </div>
                </div>
            `;
        }
        
        function renderResultsForm(monthId) {
            const container = document.getElementById('results-form');
            if (!monthId || !monthlyData[monthId]) {
                document.getElementById('month-completed-checkbox').checked = false;
                document.getElementById('geral_podium_img').value = '';
                container.innerHTML = '<p class="text-center text-gray-500">Este mês ainda não foi criado. Clique em "Novo Mês" para começar.</p>'; return;
            }
            let data = monthlyData[monthId];
            
             if ((data.etapa1 || data.etapa2) && !data.stages) {
                const migratedStages = [];
                for (let i = 1; i <= 4; i++) {
                    const etapaKey = `etapa${i}`;
                    if (data[etapaKey] && Array.isArray(data[etapaKey]) && data[etapaKey].length > 0) {
                        migratedStages.push({
                            id: `${etapaKey}_${monthId}`, name: `Etapa ${i}`, date: '', type: '', durationDistance: '',
                            podium_img: data[`${etapaKey}_podium_img`] || '',
                            results: data[etapaKey]
                        });
                    }
                }
                data.stages = migratedStages;
            }

            document.getElementById('month-completed-checkbox').checked = data.isCompleted || false;
            document.getElementById('geral_podium_img').value = data.geral_podium_img || '';
            const stages = data.stages || [];

            const today = new Date().toISOString().split('T')[0];
            let nextStageIndex = -1;
            stages.find((stage, index) => { 
                if (stage.date >= today) {
                    nextStageIndex = index;
                    return true;
                }
                return false;
            });

            if (nextStageIndex === -1 && stages.length > 0) {
                nextStageIndex = stages.length - 1;
            }

            container.innerHTML = stages.map((stage, i) => createStageFormHTML(stage, i, i === nextStageIndex)).join('') || '<p class="text-center text-gray-500">Nenhuma etapa criada para este mês. Adicione uma!</p>';
        }

        function getThursdays(year, month) {
            const thursdays = [];
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                if (date.getDay() === 4) { // Thursday
                    thursdays.push(new Date(date.getTime()));
                }
                date.setDate(date.getDate() + 1);
            }
            return thursdays.map(d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
        }
        
        function setupDashboardEventListeners() {
            document.getElementById('info-modal-close').addEventListener('click', () => closeModal('info-modal'));
            
            document.getElementById('logout-btn').addEventListener('click', async () => {
                try { await signOut(auth); } catch (error) { console.error("Erro ao sair:", error); }
            });

            document.getElementById('admin-menu').addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.target.closest('a')?.dataset.target;
                if (!targetId) return;
                document.querySelectorAll('.admin-section').forEach(section => section.classList.add('hidden'));
                document.querySelectorAll('.admin-menu-item').forEach(item => item.classList.remove('active'));
                document.getElementById(targetId).classList.remove('hidden');
                e.target.closest('a').classList.add('active');
            });
            document.querySelector('.admin-menu-item[data-target="section-resultados"]').classList.add('active');
            
            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const btn = document.getElementById('save-settings-btn');
                btn.disabled = true;
                btn.textContent = 'A guardar...';
                const newBaseUrl = document.getElementById('image-base-url').value.trim();
                try {
                    const settingsRef = doc(db, "settings", "config");
                    await setDoc(settingsRef, { imageBaseUrl: newBaseUrl }, { merge: true });
                    imageBaseUrl = newBaseUrl;
                    await logAction('SETTINGS_UPDATED', `URL base das imagens foi atualizada.`);
                    openInfoModal('Configurações guardadas com sucesso!');
                } catch (error) {
                    console.error("Erro ao guardar configurações:", error);
                    openInfoModal('Ocorreu um erro ao guardar as configurações.');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Guardar Configurações';
                }
            });
        
            document.getElementById('results-form').addEventListener('input', (e) => {
                if (e.target.classList.contains('filter-available-participants')) {
                    const filterText = e.target.value.toLowerCase();
                    const availableList = e.target.nextElementSibling;
                    availableList.querySelectorAll('.available-participant').forEach(item => {
                        item.style.display = item.dataset.name.includes(filterText) ? 'flex' : 'none';
                    });
                }
            });

            document.getElementById('results-form').addEventListener('click', async (e) => {
                const header = e.target.closest('.accordion-header');
                if (header) {
                    const content = header.nextElementSibling;
                    content.classList.toggle('hidden');
                    header.querySelector('.accordion-icon').classList.toggle('rotate-180');
                    return;
                }

                const button = e.target.closest('button');
                if (!button) return;

                const participantItem = button.closest('.participant-item');
                
                const renumberClassifiedList = (list) => {
                    list.querySelectorAll('.classified-participant').forEach((item, index) => {
                        const nameSpan = item.querySelector('span');
                        nameSpan.textContent = `${index + 1}. ${participantsData[item.dataset.id].name}`;
                    });
                };

                if (button.classList.contains('add-participant-to-stage-btn')) {
                    const classifiedList = participantItem.closest('.grid').querySelector('.classified-list');
                    const pId = participantItem.dataset.id;
                    const pName = participantsData[pId].name;

                    const newItem = document.createElement('div');
                    newItem.className = 'participant-item classified-participant';
                    newItem.dataset.id = pId;
                    newItem.innerHTML = `<span>${pName}</span><div class="space-x-2"><button type="button" class="text-gray-500 hover:text-gray-700 move-up-btn"><i class="fas fa-arrow-up"></i></button><button type="button" class="text-gray-500 hover:text-gray-700 move-down-btn"><i class="fas fa-arrow-down"></i></button><button type="button" class="text-red-500 hover:text-red-700 remove-participant-from-stage-btn"><i class="fas fa-trash"></i></button></div>`;
                    classifiedList.appendChild(newItem);
                    renumberClassifiedList(classifiedList);
                    participantItem.remove();
                } else if (button.classList.contains('remove-participant-from-stage-btn')) {
                    const availableList = participantItem.closest('.grid').querySelector('.available-list');
                    const classifiedList = participantItem.parentElement;
                    const pId = participantItem.dataset.id;
                    const pName = participantsData[pId].name;

                    const newItem = document.createElement('div');
                    newItem.className = 'participant-item available-participant';
                    newItem.dataset.id = pId;
                    newItem.dataset.name = pName.toLowerCase();
                    newItem.innerHTML = `<span>${pName}</span><button type="button" class="text-green-500 hover:text-green-700 add-participant-to-stage-btn"><i class="fas fa-plus-circle"></i></button>`;
                    availableList.appendChild(newItem);
                    participantItem.remove();
                    renumberClassifiedList(classifiedList);
                } else if(button.classList.contains('move-up-btn')) {
                    if(participantItem.previousElementSibling) {
                        participantItem.parentElement.insertBefore(participantItem, participantItem.previousElementSibling);
                        renumberClassifiedList(participantItem.parentElement);
                    }
                } else if(button.classList.contains('move-down-btn')) {
                    if(participantItem.nextElementSibling) {
                        participantItem.parentElement.insertBefore(participantItem.nextElementSibling, participantItem);
                        renumberClassifiedList(participantItem.parentElement);
                    }
                } else if (button.classList.contains('remove-stage-btn')) {
                    const confirmed = await openConfirmModal('Tem a certeza que deseja remover esta etapa?');
                    if(confirmed) {
                         button.closest('.stage-form-group').remove();
                    }
                }
            });
            
            document.getElementById('add-stage-btn').addEventListener('click', () => {
                const container = document.getElementById('results-form');
                const newIndex = container.querySelectorAll('.stage-form-group').length;
                const newStageHTML = createStageFormHTML({ id: `new_stage_${Date.now()}`}, newIndex, true);
                
                if(newIndex === 0 && container.querySelector('p')) container.innerHTML = ''; 
                container.insertAdjacentHTML('beforeend', newStageHTML);
            });
            
            document.getElementById('save-results-btn').addEventListener('click', async () => {
                const monthId = document.getElementById('month-select-admin').value;
                if (!monthId) return;

                const docRef = doc(db, 'results', monthId);
                const isCompleted = document.getElementById('month-completed-checkbox').checked;
                const geralPodiumImg = document.getElementById('geral_podium_img').value.trim();
                const newStages = [];
                
                document.querySelectorAll('#results-form .stage-form-group').forEach(group => {
                    const classifiedIds = [];
                    group.querySelectorAll('.classified-list .classified-participant').forEach(item => {
                        classifiedIds.push(item.dataset.id);
                    });

                    const stage = {
                        id: group.dataset.stageId,
                        name: group.querySelector('.stage-name').value.trim(),
                        date: group.querySelector('.stage-date').value,
                        type: group.querySelector('.stage-type').value,
                        durationDistance: group.querySelector('.stage-duration-distance').value.trim(),
                        podium_img: group.querySelector('.stage-podium-img').value.trim(),
                        results: classifiedIds.map(id => ({ id }))
                    };
                    newStages.push(stage);
                });
                
                try {
                    const dataToSave = { 
                        title: monthlyData[monthId]?.title || `${monthId.split('_')[1]}/${monthId.split('_')[0]}`, 
                        stages: newStages, 
                        isCompleted: isCompleted,
                        geral_podium_img: geralPodiumImg
                    };

                    await setDoc(docRef, dataToSave, { merge: true });
                    await logAction('RESULTS_SAVED', `Resultados do mês "${dataToSave.title}" foram guardados.`);
                    openInfoModal('Resultados guardados com sucesso!');
                    loadAllData();
                } catch (error) {
                    console.error("Erro ao guardar resultados:", error);
                    openInfoModal("Ocorreu um erro ao guardar os resultados.");
                }
            });
            
            document.getElementById('new-month-btn').addEventListener('click', async () => {
                const monthId = await openPromptModal("Insira um ID para o novo mês NO FORMATO AAAA_MM (ex: 2025_09):");
                if (!monthId || !/^\d{4}_\d{2}$/.test(monthId)) {
                    if(monthId) openInfoModal("Formato inválido! Utilize o formato AAAA_MM (ex: 2025_09)."); 
                    return;
                }
                if (monthlyData[monthId]) {
                    openInfoModal("Este mês já existe!"); return;
                }

                const monthTitle = await openPromptModal("Insira o título para o novo mês (ex: Setembro/2025):");
                if (!monthTitle) return;

                try {
                    const [year, month] = monthId.split('_').map(Number);
                    const thursdays = getThursdays(year, month);
                    
                    const newStages = thursdays.map((thursdayDate, index) => ({
                        id: `etapa_${index + 1}_${Date.now()}`,
                        name: `Etapa ${index + 1}`,
                        date: thursdayDate,
                        type: 'Circuito',
                        durationDistance: '55 min + 1 volta',
                        podium_img: '',
                        results: []
                    }));

                    const newMonthData = { title: monthTitle, stages: newStages, isCompleted: false, geral_podium_img: '' };
                    await setDoc(doc(db, 'results', monthId), newMonthData);
                    await logAction('MONTH_CREATED', `Novo mês "${monthTitle}" (${monthId}) foi criado.`);
                    openInfoModal(`Novo mês criado com ${newStages.length} etapas (quintas-feiras)!`);
                    
                    monthlyData[monthId] = newMonthData;
                    renderMonthSelector();
                    document.getElementById('month-select-admin').value = monthId;
                    renderResultsForm(monthId);

                } catch (error) {
                    console.error("Erro ao criar mês:", error);
                    openInfoModal(`Erro: ${error.message}`);
                }
            });
        }
        
        async function initializeAuth() {
            try {
                await setPersistence(auth, browserSessionPersistence);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        showDashboard();
                    } else {
                        showLogin();
                    }
                });
            } catch (error) {
                console.error("Erro ao definir a persistência da autenticação:", error);
                onAuthStateChanged(auth, (user) => {
                    if (user) { showDashboard(); } else { showLogin(); }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try { 
                    await signInWithEmailAndPassword(auth, email, password); 
                } catch (error) { 
                    openInfoModal('Email ou palavra-passe incorreta!'); 
                }
            });
            initializeAuth();
        });

    </script>
</body>
</html>

