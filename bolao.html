<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- Metadados essenciais -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolão do Rachão - Rachão Santa Casa</title>
    
    <!-- CDNs de Estilos e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Estilos Personalizados -->
    <style>
        :root {
            --bg-color: #f4f4f5;
            --card-bg-color: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --accent-color: #eab308;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); }
        .card { 
            background-color: var(--card-bg-color); 
            border-radius: 1.5rem; 
            padding: 2.5rem; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem; 
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background-color: #f9fafb;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .input-field:hover {
             border-color: #d1d5db;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.2);
        }
         .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
        }
        .btn-primary { background-color: var(--accent-color); color: var(--text-primary); }
        .btn-primary:hover:not(:disabled) { background-color: #f59e0b; }
         .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }
        .stat-bar-bg {
            background-color: #f3f4f6;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }
        .stat-bar {
            background-color: var(--accent-color);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 0.5rem;
            color: white;
            font-size: 0.75rem;
            line-height: 1.25rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-5xl mx-auto p-4 md:p-8">
        <header class="text-center mb-6">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo Rachão Santa Casa" class="w-full max-w-[280px] mx-auto">
            <nav class="mt-4">
                <ul class="flex justify-center gap-6 md:gap-8">
                    <li><a href="index.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Classificação</a></li>
                    <li><a href="ranking_geral.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Ranking Geral</a></li>
                    <li><a href="equipes.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Equipes</a></li>
                    <li><a href="noticias.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Notícias</a></li>
                    <li><a href="bolao.html" class="font-semibold text-yellow-500 transition">Bolão</a></li>
                    <li><a href="sobre.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Sobre o Rachão</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <div id="loading-overlay" class="text-center p-10 card">
                <p class="text-lg font-semibold text-gray-500">A carregar o Bolão...</p>
            </div>

            <div id="bolao-container" class="hidden">
                 <div class="card">
                    <h1 class="text-3xl font-extrabold text-center mb-2">Bolão do Rachão</h1>
                    <p class="text-center text-gray-500 mb-8">Dê o seu palpite para o pódio das próximas etapas!</p>

                    <div class="space-y-6 max-w-lg mx-auto">
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <label for="stage-select" class="font-semibold shrink-0">Escolha a Etapa:</label>
                            <select id="stage-select" class="input-field flex-grow"></select>
                        </div>

                        <form id="bet-form" class="space-y-4 hidden">
                            <div>
                                <label for="first-place" class="font-semibold block mb-1">1º Lugar:</label>
                                <select id="first-place" class="input-field participant-select"></select>
                            </div>
                             <div>
                                <label for="second-place" class="font-semibold block mb-1">2º Lugar:</label>
                                <select id="second-place" class="input-field participant-select"></select>
                            </div>
                             <div>
                                <label for="third-place" class="font-semibold block mb-1">3º Lugar:</label>
                                <select id="third-place" class="input-field participant-select"></select>
                            </div>
                             <div>
                                <label for="fourth-place" class="font-semibold block mb-1">4º Lugar:</label>
                                <select id="fourth-place" class="input-field participant-select"></select>
                            </div>
                             <div>
                                <label for="fifth-place" class="font-semibold block mb-1">5º Lugar:</label>
                                <select id="fifth-place" class="input-field participant-select"></select>
                            </div>
                            <button type="submit" class="btn btn-primary w-full !py-3 !text-base">Submeter Palpite</button>
                        </form>

                        <div id="user-bet-display" class="hidden text-center bg-yellow-50 border-2 border-yellow-200 p-6 rounded-2xl">
                            <h3 class="font-bold text-lg mb-2 text-yellow-800">O seu palpite para esta etapa:</h3>
                            <p id="user-bet-text" class="text-yellow-700 mb-4 leading-relaxed"></p>
                            <button id="edit-bet-btn" class="btn btn-secondary">Editar Palpite</button>
                        </div>
                         <div id="no-stages-message" class="hidden text-center text-gray-500 py-8">
                            <p>De momento, não há etapas futuras disponíveis para palpites.</p>
                        </div>
                    </div>
                </div>
                 <div id="stats-container" class="card hidden">
                    <h2 class="text-2xl font-bold text-center mb-8">Estatísticas de Palpites da Etapa</h2>
                    <div id="stats-content" class="space-y-6">
                        <!-- As barras de estatísticas serão injetadas aqui -->
                    </div>
                </div>
            </div>
        </main>
    
        <div class="text-center mt-8">
            <a href="admin.html" class="inline-block bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition shadow-sm">
                <i class="fas fa-user-shield mr-2"></i> Acesso Administrativo
            </a>
        </div>
        
        <footer class="mt-12 pt-8 text-center text-gray-500 border-t border-gray-200">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo Rachão Santa Casa" class="w-20 h-auto mx-auto mb-2 opacity-80">
            <p class="text-sm font-semibold">Nós pedalamos forte, mas o que nos mantém juntos é a amizade.</p>
        </footer>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // A configuração do Firebase é pública por design. A segurança é garantida pelas Regras de Segurança do Firestore.
        const firebaseConfig = {
            apiKey: "AIzaSyCWsgx2mSOPwNwWBwl373DJ3oj7VuFwy9Y",
            authDomain: "rachaosc.firebaseapp.com",
            projectId: "rachaosc",
            storageBucket: "rachaosc.appspot.com",
            messagingSenderId: "28309536958",
            appId: "1:28309536958:web:eac51586cdabd82f691eef"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Variáveis de Estado Global ---
        let userId = null;
        let participantsData = {};
        let upcomingStages = [];
        let allStageBets = [];

        // --- Inicialização ---
        async function initializeAppLogica() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await loadData();
                } else {
                    await signInAnonymously(auth); // Garante que o utilizador anónimo seja criado
                }
            });
        }

        async function loadData() {
            try {
                const [pSnap, rSnap, settingsSnap] = await Promise.all([
                    getDocs(collection(db, "participants")),
                    getDocs(collection(db, "results")),
                    getDoc(doc(db, "settings", "config"))
                ]);

                const sporadicRiders = settingsSnap.exists() ? settingsSnap.data().sporadicRiders || [] : [];
                
                participantsData = {};
                pSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.isActive !== false && !sporadicRiders.includes(doc.id)) {
                        participantsData[doc.id] = data;
                    }
                });

                const currentDate = new Date().toISOString().split('T')[0];
                upcomingStages = [];
                rSnap.forEach(resultDoc => {
                    const monthData = resultDoc.data();
                    (monthData.stages || []).forEach(stage => {
                        // Aposta permitida apenas para etapas futuras
                        if (stage.date >= currentDate && stage.status !== 'Cancelada' && stage.status !== 'Adiada') {
                            upcomingStages.push({
                                id: stage.id,
                                name: `${monthData.title} - ${stage.name}`,
                                monthId: resultDoc.id
                            });
                        }
                    });
                });
                
                renderBolao();
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
            }
        }

        // --- Renderização da UI ---
        async function renderBolao() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const bolaoContainer = document.getElementById('bolao-container');
            const stageSelect = document.getElementById('stage-select');
            const betForm = document.getElementById('bet-form');
            const noStagesMessage = document.getElementById('no-stages-message');

            loadingOverlay.style.display = 'none';
            bolaoContainer.style.display = 'block';

            if (upcomingStages.length === 0) {
                betForm.style.display = 'none';
                noStagesMessage.style.display = 'block';
                return;
            }

            stageSelect.innerHTML = '';
            upcomingStages.forEach(stage => {
                stageSelect.add(new Option(stage.name, stage.id));
            });
            
            populateParticipantSelects();
            await loadBetsAndRenderStats();
            
            stageSelect.addEventListener('change', loadBetsAndRenderStats);
            betForm.addEventListener('submit', saveBet);
            document.querySelectorAll('.participant-select').forEach(sel => sel.addEventListener('change', handleDuplicateSelection));
            document.getElementById('edit-bet-btn').addEventListener('click', editBet);
        }

        function populateParticipantSelects() {
            const selects = document.querySelectorAll('.participant-select');
            const sortedParticipants = Object.entries(participantsData).sort((a,b) => a[1].name.localeCompare(b[1].name));
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione um participante...</option>';
                sortedParticipants.forEach(([id, p]) => {
                    select.add(new Option(p.name.toUpperCase(), id));
                });
            });
        }

        async function loadBetsAndRenderStats() {
            const stageId = document.getElementById('stage-select').value;
            if (!stageId) return;

            // Carrega todos os palpites para a etapa selecionada
            const betsQuery = query(collection(db, "bolao_bets"), where("stageId", "==", stageId));
            const betsSnapshot = await getDocs(betsQuery);
            allStageBets = [];
            betsSnapshot.forEach(doc => {
                allStageBets.push({ id: doc.id, ...doc.data() });
            });

            renderUserBetStatus();
            renderBetStats();
        }

        function renderUserBetStatus() {
            const betForm = document.getElementById('bet-form');
            const userBetDisplay = document.getElementById('user-bet-display');
            const userBet = allStageBets.find(b => b.userId === userId);

            if (userBet) {
                const first = participantsData[userBet.firstPlace]?.name.toUpperCase() || 'N/A';
                const second = participantsData[userBet.secondPlace]?.name.toUpperCase() || 'N/A';
                const third = participantsData[userBet.thirdPlace]?.name.toUpperCase() || 'N/A';
                const fourth = participantsData[userBet.fourthPlace]?.name.toUpperCase() || 'N/A';
                const fifth = participantsData[userBet.fifthPlace]?.name.toUpperCase() || 'N/A';
                document.getElementById('user-bet-text').innerHTML = `<b>1º:</b> ${first}, <b>2º:</b> ${second}, <b>3º:</b> ${third}, <br><b>4º:</b> ${fourth}, <b>5º:</b> ${fifth}`;
                betForm.style.display = 'none';
                userBetDisplay.style.display = 'block';
            } else {
                betForm.style.display = 'block';
                userBetDisplay.style.display = 'none';
                betForm.reset();
            }
        }

        function renderBetStats() {
            const statsContainer = document.getElementById('stats-container');
            const statsContent = document.getElementById('stats-content');
            statsContent.innerHTML = '';

            if (allStageBets.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }

            statsContainer.style.display = 'block';
            const votesByPosition = { '1': {}, '2': {}, '3': {}, '4': {}, '5': {} };
            const positionKeys = { '1': 'firstPlace', '2': 'secondPlace', '3': 'thirdPlace', '4': 'fourthPlace', '5': 'fifthPlace' };

            allStageBets.forEach(bet => {
                for (const position in positionKeys) {
                    const participantId = bet[positionKeys[position]];
                    if (participantId) {
                        votesByPosition[position][participantId] = (votesByPosition[position][participantId] || 0) + 1;
                    }
                }
            });
            
            for (const position in votesByPosition) {
                const votes = votesByPosition[position];
                if (Object.keys(votes).length === 0) continue;

                const positionTitle = document.createElement('h3');
                positionTitle.className = 'text-xl font-bold text-center mt-8 mb-4 border-t border-gray-200 pt-6 first:mt-0 first:border-t-0';
                positionTitle.textContent = `Mais Votados para ${position}º Lugar`;
                statsContent.appendChild(positionTitle);

                const sortedVotes = Object.entries(votes).sort((a,b) => b[1] - a[1]).slice(0, 5); // Mostra o Top 5

                sortedVotes.forEach(([participantId, count]) => {
                    const percentage = ((count / allStageBets.length) * 100);
                    const participantName = participantsData[participantId]?.name.toUpperCase() || 'Desconhecido';
                    const barHtml = `
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-semibold">${participantName}</span>
                                <span class="text-sm font-bold text-gray-600">${count} Voto(s)</span>
                            </div>
                            <div class="stat-bar-bg w-full">
                                <div class="stat-bar" style="width: ${percentage}%;">${percentage.toFixed(0)}%</div>
                            </div>
                        </div>
                    `;
                    statsContent.insertAdjacentHTML('beforeend', barHtml);
                });
            }
        }

        // --- Manipuladores de Eventos ---
        function handleDuplicateSelection(e) {
            const selects = Array.from(document.querySelectorAll('.participant-select'));
            const currentSelect = e.target;
            const selectedValue = currentSelect.value;
            if(!selectedValue) return;

            selects.forEach(select => {
                if (select !== currentSelect && select.value === selectedValue) {
                    alert('Este participante já foi escolhido para outra posição. Por favor, selecione outro.');
                    currentSelect.value = '';
                }
            });
        }
        
        function editBet() {
            const userBet = allStageBets.find(b => b.userId === userId);
            if (!userBet) return;

            document.getElementById('first-place').value = userBet.firstPlace;
            document.getElementById('second-place').value = userBet.secondPlace;
            document.getElementById('third-place').value = userBet.thirdPlace;
            document.getElementById('fourth-place').value = userBet.fourthPlace;
            document.getElementById('fifth-place').value = userBet.fifthPlace;

            document.getElementById('user-bet-display').style.display = 'none';
            document.getElementById('bet-form').style.display = 'block';
            document.querySelector('#bet-form button[type="submit"]').textContent = 'Atualizar Palpite';
        }

        async function saveBet(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const stageId = document.getElementById('stage-select').value;

            const firstPlace = document.getElementById('first-place').value;
            const secondPlace = document.getElementById('second-place').value;
            const thirdPlace = document.getElementById('third-place').value;
            const fourthPlace = document.getElementById('fourth-place').value;
            const fifthPlace = document.getElementById('fifth-place').value;

            if(!firstPlace || !secondPlace || !thirdPlace || !fourthPlace || !fifthPlace) {
                alert('Por favor, preencha todas as cinco posições do pódio.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'A guardar...';

            try {
                // A segurança deve ser reforçada com Regras de Segurança do Firestore para impedir palpites após o início da etapa.
                const betRef = doc(db, 'bolao_bets', `${stageId}_${userId}`);
                await setDoc(betRef, {
                    stageId, userId, firstPlace, secondPlace, thirdPlace, fourthPlace, fifthPlace, createdAt: new Date()
                });
                alert('Palpite guardado com sucesso!');
                await loadBetsAndRenderStats();
            } catch (error) {
                console.error("Erro ao guardar palpite:", error);
                alert('Ocorreu um erro ao guardar o seu palpite.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submeter Palpite';
            }
        }
        
        // Inicia a aplicação
        initializeAppLogica();
    </script>
</body>
</html>

