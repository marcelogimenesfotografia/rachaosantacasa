<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- Metadados essenciais -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classificação Rachão Santa Casa.</title>
    
    <!-- CDNs de Estilos e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos Personalizados -->
    <style>
        /* * DESIGN SYSTEM: GOOGLE-INSPIRED LAYOUT
         * Foco em clareza, cards, tipografia e hierarquia visual.
         */

        /* Variáveis de Cor (Tema Claro) */
        :root {
            --bg-color: #f4f4f5; /* Cinza claro */
            --card-bg-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937; /* Cinza escuro */
            --text-secondary: #6b7280; /* Cinza médio */
            --accent-color: #eab308; /* Amarelo/Dourado */
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        /* Estilos Globais */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* Estrutura de Card */
        .card {
            background-color: var(--card-bg-color);
            border-radius: 1rem; /* 16px */
            padding: 1.5rem; /* 24px */
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem; /* 32px */
        }
        
        /* Filtros e Abas */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
             /* margin-bottom is now handled by .card */
        }

        #month-select {
            background-color: var(--bg-color); /* Fundo um pouco diferente para se destacar do card */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        #month-select option {
            background-color: #ffffff;
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .tab-button {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-secondary);
            background-color: transparent;
            position: relative;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--accent-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }

        /* Pódio Visual */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 1rem;
            padding: 2rem 0;
            text-align: center;
        }

        .podium-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 33.33%;
        }

        .podium-rank {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .podium-rank-1 { color: var(--gold); order: 2; transform: translateY(-20px); }
        .podium-rank-2 { color: var(--silver); order: 1; }
        .podium-rank-3 { color: var(--bronze); order: 3; }

        .podium-image {
            border-radius: 50%;
            object-fit: cover;
            margin-top: 0.5rem;
            border: 4px solid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .podium-image-1 { width: 140px; height: 140px; border-color: var(--gold); }
        .podium-image-2 { width: 110px; height: 110px; border-color: var(--silver); }
        .podium-image-3 { width: 110px; height: 110px; border-color: var(--bronze); }

        .podium-name {
            font-weight: 600;
            margin-top: 1rem;
            color: var(--text-primary);
        }

        .podium-points {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Tabela de Classificação */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th, .leaderboard-table td {
            padding: 1rem;
            text-align: left;
        }

        .leaderboard-table thead {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        .leaderboard-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color: 0.2s ease-in-out;
        }
        
        .leaderboard-table tbody tr:last-child {
            border-bottom: none;
        }

        .leaderboard-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .profile-thumb-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid var(--border-color);
        }

        .profile-thumb {
            width: 100%; height: 100%; object-fit: cover;
        }

        /* Modal */
        .modal { display: none; /* Alterado para ser controlado por JS */ }
        .modal.is-open { display: flex; }
        .modal-content.card {
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative; /* Garante que o botão de fechar fique posicionado em relação ao modal */
        }
        .modal-image {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 3px solid var(--border-color);
        }

        /* Interações: Curtidas e Comentários */
        .interaction-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f9fafb;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .interaction-button:hover { background-color: #f4f4f5; color: var(--text-primary); }
        .interaction-button .fa-heart.liked { color: #ef4444; }

        .comment-input {
            background-color: #f9fafb; /* Cinza muito claro */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .comment-input:focus { outline: none; border-color: var(--accent-color); }
        
        .comment-box {
            background-color: #f9fafb; /* Cinza muito claro */
            padding: 1rem;
            border-radius: 1rem;
        }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-5xl mx-auto p-4 md:p-6">
        <header class="text-center mb-6">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo Rachão Santa Casa" class="w-full max-w-[280px] mx-auto">
            <nav class="mt-4">
                <ul class="flex justify-center gap-6 md:gap-8">
                    <li><a href="index.html" class="font-semibold text-yellow-500 transition">Classificação</a></li>
                    <li><a href="ranking_geral.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Ranking do Ano</a></li>
                    <li><a href="sobre.html" class="font-semibold text-gray-700 hover:text-yellow-500 transition">Sobre o Rachão</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <div id="loading-overlay" class="text-center p-10">
                <p class="text-lg font-semibold text-gray-500">Carregando dados...</p>
            </div>

            <div id="content-wrapper" class="hidden">
                <!-- Filtros -->
                <div class="filter-container card">
                    <select id="month-select"></select>
                    <div id="tabs-container" class="tabs">
                        <button id="tab-geral" class="tab-button active">Geral</button>
                        <button id="tab-etapa1" class="tab-button">Etapa 1</button>
                        <button id="tab-etapa2" class="tab-button">Etapa 2</button>
                        <button id="tab-etapa3" class="tab-button">Etapa 3</button>
                        <button id="tab-etapa4" class="tab-button">Etapa 4</button>
                    </div>
                </div>

                <!-- Conteúdo Dinâmico -->
                <div id="dynamic-content"></div>
            </div>
        </main>
    
        <!-- Modal de Detalhes -->
        <div id="details-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70">
            <div id="modal-content-container" class="modal-content card">
                <!-- Conteúdo injetado por JS -->
            </div>
        </div>
        
        <!-- Modal de Confirmação de Exclusão -->
        <div id="delete-confirmation-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70">
            <div class="modal-content card max-w-sm">
                <h3 class="text-lg font-bold mb-4">Confirmar Exclusão</h3>
                <p class="mb-6 text-gray-600">Tem certeza que deseja apagar? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Apagar</button>
                </div>
            </div>
        </div>
        
        <footer class="mt-12 pt-8 text-center text-gray-500 border-t border-gray-200">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo Rachão Santa Casa" class="w-20 h-auto mx-auto mb-2 opacity-80">
            <p class="text-sm font-semibold">Nós pedalamos forte, mas o que nos mantém juntos é a amizade.</p>
        </footer>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, serverTimestamp, query, orderBy, getDocs, deleteDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const ADMIN_USER_ID = "COLOQUE_O_SEU_USER_ID_AQUI"; 
        const firebaseConfig = {
            apiKey: "AIzaSyCWsgx2mSOPwNwWBwl373DJ3oj7VuFwy9Y",
            authDomain: "rachaosc.firebaseapp.com",
            projectId: "rachaosc",
            storageBucket: "rachaosc.appspot.com",
            messagingSenderId: "28309536958",
            appId: "1:28309536958:web:eac51586cdabd82f691eef"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let likesData = {};
        let commentsData = {};
        let monthlyData = {};
        let participantsData = {};
        let sporadicRiders = [];
        
        let allParticipantsData = [];
        let currentTab = 'geral';

        function getPlaceholderImageUrl(name) {
            const firstLetter = name ? name.charAt(0).toUpperCase() : '?';
            return `https://placehold.co/200x200/e5e7eb/000000?text=${firstLetter}`;
        }

        // --- LÓGICA DE PROCESSAMENTO DE DADOS ---
        function processStageData(stageData) {
            if (!stageData) return [];
            const pointsDistribution = [15, 13, 11, 9, 7, 5, 3, 1, 1, 1];
            let pointsIndex = 0; // Este índice conta a posição para atribuição de pontos (apenas para não esporádicos)
            return stageData.map(participant => {
                if (sporadicRiders.includes(participant.name)) {
                    // Esporádicos recebem 0 pontos e não "consomem" uma posição na distribuição de pontos.
                    return { ...participant, pts: 0 };
                } else {
                    // Não esporádicos recebem os pontos da sua posição efetiva na classificação.
                    const points = pointsDistribution[pointsIndex] || 0;
                    pointsIndex++; // O índice de pontos só avança para participantes que pontuam.
                    return { ...participant, pts: points };
                }
            });
        }
        
        function getProcessedMonthData(monthId) {
            const data = JSON.parse(JSON.stringify(monthlyData[monthId]));
            ['etapa1', 'etapa2', 'etapa3', 'etapa4'].forEach(etapa => {
                if(data[etapa]) data[etapa] = processStageData(data[etapa]);
            });
            return data;
        }

        function calculateOverall(etapas) {
            const allParticipants = new Set(Object.values(etapas).flat().map(p => p.name));
            const overallData = Array.from(allParticipants).map(name => {
                if (sporadicRiders.includes(name)) return null;
                const points = {};
                let totalPoints = 0;
                for (let i = 1; i <= 4; i++) {
                    const etapaKey = `etapa${i}`;
                    const p = (etapas[etapaKey] || []).find(p => p.name === name) || { pts: 0 };
                    points[`pts_etapa_${i}`] = p.pts;
                    totalPoints += p.pts;
                }
                return { name, ...points, pts: totalPoints };
            }).filter(Boolean);
            
            overallData.sort((a, b) => b.pts - a.pts);
            return overallData.map((item, index) => ({ ...item, pos: index + 1 }));
        }

        function getParticipantData(overallData) {
            return overallData.map(p => {
                const info = participantsData[p.name] || {};
                return { ...p, ...info, image: info.imageUrl || getPlaceholderImageUrl(p.name) };
            });
        }
        
        // --- RENDERIZAÇÃO DINÂMICA DO CONTEÚDO ---
        function renderContent(monthId, tab) {
            if (!userId || !monthlyData[monthId]) return;

            const contentWrapper = document.getElementById('content-wrapper');
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.add('hidden');
            contentWrapper.classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`)?.classList.add('active');

            const monthData = getProcessedMonthData(monthId);
            const originalMonthData = monthlyData[monthId];
            const dynamicContentContainer = document.getElementById('dynamic-content');
            dynamicContentContainer.innerHTML = '';
            
            let dataToShow;
            let isOverall = false;
            let stageId = `${monthId}_${tab}`;
            
            if (tab === 'geral') {
                const overall = calculateOverall({etapa1: monthData.etapa1, etapa2: monthData.etapa2, etapa3: monthData.etapa3, etapa4: monthData.etapa4});
                allParticipantsData = getParticipantData(overall);
                dataToShow = allParticipantsData;
                isOverall = true;
            } else {
                const stageData = originalMonthData[tab] ? originalMonthData[tab].map((p, index) => {
                    const processed = (monthData[tab] || []).find(proc => proc.name === p.name);
                    const info = participantsData[p.name] || {};
                    return { ...p, pos: index + 1, pts: processed ? processed.pts : 0, ...info, image: info.imageUrl || getPlaceholderImageUrl(p.name) };
                }) : [];
                dataToShow = stageData;
            }

            dynamicContentContainer.appendChild(createContentCard(monthData.title, dataToShow, isOverall, monthId, tab));
            renderCommentsAndReplies(stageId);
        }
        
        function createContentCard(title, data, isOverall, monthId, tab) {
            const card = document.createElement('div');
            card.className = 'card';
            
            const hasData = data && data.length > 0;
            const stageId = `${monthId}_${tab}`;

            // Pódio
            const hasAllStages = ['etapa1', 'etapa2', 'etapa3', 'etapa4'].every(e => monthlyData[monthId][e]?.length > 0);
            if (isOverall && hasData && data.length >= 3 && hasAllStages) {
                card.appendChild(createPodium(data.slice(0, 3)));
            }

            // Tabela
            if (hasData) {
                const tableStartIndex = (isOverall && hasAllStages && data.length >= 3) ? 3 : 0;
                card.appendChild(createTable(data.slice(tableStartIndex), isOverall));
            } else {
                card.innerHTML = `<p class="text-center text-gray-400">Nenhum dado para esta etapa.</p>`;
            }

            // Interações
            const podiumImageUrl = monthlyData[monthId][`${tab}_podium_img`];
            if(podiumImageUrl) {
                const podiumImageContainer = document.createElement('div');
                podiumImageContainer.className = 'mt-8 text-center';
                podiumImageContainer.innerHTML = `<img src="${podiumImageUrl}" alt="Foto do Pódio" class="mx-auto rounded-lg shadow-lg max-w-full h-auto">`;
                card.appendChild(podiumImageContainer);
            }
            
            if (hasData || podiumImageUrl) {
                card.appendChild(createInteractionsSection(stageId, monthId, tab));
            }
            
            return card;
        }

        function createPodium(podiumData) {
            const container = document.createElement('div');
            container.className = 'podium-container mb-8';
            podiumData.forEach((p, index) => {
                const rank = p.pos;
                const step = document.createElement('div');
                step.className = `podium-step podium-rank-${rank}`;
                step.innerHTML = `
                    <div class="podium-rank">${rank}</div>
                    <img src="${p.image}" alt="Foto de ${p.name}" class="podium-image podium-image-${rank}">
                    <div class="podium-name">${p.name}</div>
                    <div class="podium-points">${p.pts} pts</div>
                `;
                step.addEventListener('click', () => openModal(p.name));
                container.appendChild(step);
            });
            return container;
        }
        
        function createTable(data, isOverall) {
            const table = document.createElement('table');
            table.className = 'leaderboard-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="w-12">#</th>
                        <th>Participante</th>
                        <th class="text-right">Pts</th>
                        ${isOverall ? '<th class="text-right hidden md:table-cell">Etapas</th>' : ''}
                    </tr>
                </thead>
            `;
            const tbody = document.createElement('tbody');
            data.forEach(p => {
                const isSporadic = !isOverall && sporadicRiders.includes(p.name);
                const row = document.createElement('tr');
                row.className = 'cursor-pointer';
                row.innerHTML = `
                    <td class="font-semibold text-gray-400">${isSporadic ? `*${p.pos}` : p.pos}</td>
                    <td>
                        <div class="flex items-center gap-4">
                            <div class="profile-thumb-wrapper"><img src="${p.image}" class="profile-thumb"></div>
                            <div>
                                <div class="font-semibold text-gray-800">${p.name}</div>
                                <div class="text-sm text-gray-400">${p.team || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="text-right font-bold text-gray-800">${isSporadic ? '-' : p.pts}</td>
                    ${isOverall ? `<td class="text-right text-sm text-gray-500 hidden md:table-cell">(${p.pts_etapa_1}|${p.pts_etapa_2}|${p.pts_etapa_3}|${p.pts_etapa_4})</td>` : ''}
                `;
                row.addEventListener('click', () => openModal(p.name));
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            return table;
        }

        function createInteractionsSection(stageId, monthId, tab) {
            const container = document.createElement('div');
            container.id = `interactions-${stageId}`;
            container.className = 'mt-8 pt-6 border-t border-gray-200';
            
            const likeInfo = likesData[stageId] || { count: 0, likedBy: [] };
            const userHasLiked = userId && likeInfo.likedBy.includes(userId);

            container.innerHTML = `
                <div class="flex justify-center mb-6">
                    <button class="interaction-button" onclick="toggleLike('${monthId}', '${tab}')">
                        <i class="fas fa-heart ${userHasLiked ? 'liked' : ''}"></i>
                        <span>${likeInfo.count}</span>
                    </button>
                </div>
                <div id="comments-section-${stageId}"></div>
            `;
            return container;
        }

        function renderCommentsAndReplies(stageId) {
            const container = document.getElementById(`comments-section-${stageId}`);
            if(!container) return;
            
            const savedName = localStorage.getItem('commenterName') || '';

            container.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Comentários</h3>
                <form onsubmit="handleCommentSubmit(event, '${stageId}')" class="mb-6 space-y-3 max-w-lg mx-auto">
                    <input type="text" name="name" placeholder="Seu nome" required class="comment-input" value="${savedName}">
                    <textarea name="comment" placeholder="Deixe seu comentário..." required rows="3" class="comment-input"></textarea>
                    <button type="submit" class="w-full bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg hover:bg-yellow-500 transition">Publicar</button>
                </form>
                <div id="comments-list-${stageId}" class="space-y-4 max-w-lg mx-auto"></div>
            `;
            
            const listContainer = document.getElementById(`comments-list-${stageId}`);
            const stageComments = commentsData[stageId] || [];
            stageComments.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

            if (stageComments.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500">Nenhum comentário ainda. Seja o primeiro!</p>`;
            } else {
                stageComments.forEach(comment => listContainer.appendChild(createCommentElement(comment, savedName)));
            }
        }
        
        function createCommentElement(comment, savedName) {
            const el = document.createElement('div');
            el.className = 'comment-box';
            
            const userHasLiked = userId && (comment.likedBy || []).includes(userId);
            const canDelete = userId === comment.authorId || userId === ADMIN_USER_ID;

            el.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-bold text-gray-800">${comment.name}</p>
                    ${canDelete ? `<button onclick="showDeleteConfirmation('comment', '${comment.id}')" class="text-gray-500 hover:text-red-500 text-sm"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>
                <p class="text-gray-600 mt-1 whitespace-pre-wrap">${comment.text}</p>
                <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                    <button onclick="toggleCommentLike('${comment.id}')" class="interaction-button text-xs py-1 px-2 ${userHasLiked ? 'liked' : ''}">
                        <i class="fas fa-heart ${userHasLiked ? 'liked' : ''}"></i> <span>${comment.likes || 0}</span>
                    </button>
                    <button onclick="toggleReplyForm('${comment.id}')" class="font-semibold hover:underline">Responder</button>
                </div>
                <div id="reply-form-container-${comment.id}" class="hidden mt-3 pl-4 border-l-2 border-gray-300">
                    <form onsubmit="handleReplySubmit(event, '${comment.id}')" class="space-y-2">
                        <input type="text" name="name" placeholder="Seu nome" required class="comment-input text-sm" value="${savedName}">
                        <textarea name="reply" placeholder="Escreva sua resposta..." required rows="2" class="comment-input text-sm"></textarea>
                        <button type="submit" class="bg-gray-700 text-white font-bold py-1 px-3 text-xs rounded-lg hover:bg-gray-600">Enviar</button>
                    </form>
                </div>
                <div id="replies-list-${comment.id}" class="mt-4 pl-4 border-l-2 border-gray-200 space-y-3"></div>
            `;
            loadReplies(comment.id);
            return el;
        }
        
        async function loadReplies(commentId) {
            const repliesContainer = document.getElementById(`replies-list-${commentId}`);
            if (!repliesContainer) return;

            const q = query(collection(db, `comments/${commentId}/replies`), orderBy("timestamp", "asc"));
            const snapshot = await getDocs(q);
            repliesContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const reply = { id: doc.id, ...doc.data() };
                const canDelete = userId === reply.authorId || userId === ADMIN_USER_ID;
                const replyEl = document.createElement('div');
                replyEl.className = 'text-sm bg-gray-100 p-3 rounded-md';
                replyEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-gray-800">${reply.name}</p>
                        ${canDelete ? `<button onclick="showDeleteConfirmation('reply', '${commentId}', '${reply.id}')" class="text-gray-500 hover:text-red-500 text-xs"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </div>
                    <p class="text-gray-600 whitespace-pre-wrap">${reply.text}</p>
                `;
                repliesContainer.appendChild(replyEl);
            });
        }


        // --- MODAIS E INTERAÇÕES ---
        function openModal(name) {
            const p = allParticipantsData.find(p => p.name === name);
            if (!p) return;

            const modalContent = document.getElementById('modal-content-container');
            const currentMonthId = document.getElementById('month-select').value;
            const monthData = getProcessedMonthData(currentMonthId);
            const originalMonthData = monthlyData[currentMonthId];

            let stagesHtml = '';
            for (let i = 1; i <= 4; i++) {
                const stageKey = `etapa${i}`;
                if (originalMonthData[stageKey]?.length > 0) {
                    const resultIndex = originalMonthData[stageKey].findIndex(res => res.name === name);
                    const result = resultIndex !== -1 ? { ...originalMonthData[stageKey][resultIndex], pos: resultIndex + 1 } : null;
                    const processedResult = (monthData[stageKey] || []).find(res => res.name === name);
                    
                    stagesHtml += `
                        <div class="bg-gray-100 p-2 rounded-md">
                            <p class="text-xs font-bold text-gray-500 uppercase">Etapa ${i}</p>
                            ${result ? `
                                <p class="text-xl font-bold text-gray-800">${sporadicRiders.includes(result.name) ? `*${result.pos}º` : `${result.pos}º`}</p>
                                <p class="text-xs text-gray-500">(${(processedResult || {pts:0}).pts} pts)</p>
                            ` : `<p class="text-xl font-bold text-gray-400">-</p>`}
                        </div>`;
                }
            }

            modalContent.innerHTML = `
                <span class="close-button absolute top-4 right-6 text-2xl cursor-pointer" onclick="closeModal('details-modal')">&times;</span>
                <img id="modal-image" class="modal-image mx-auto" src="${p.image}" alt="Foto de Perfil">
                <h3 class="text-2xl font-bold text-gray-900">${p.name}</h3>
                <p class="text-sm text-gray-600">Posição Geral: ${p.pos}º (${p.pts} pts)</p>
                <p class="text-sm text-gray-600 mt-1">${p.team || 'Sem equipe'}</p>
                <div class="mt-6 w-full">
                    <h4 class="text-md font-bold text-gray-800 mb-2 border-t border-gray-200 pt-4">Resumo de ${monthData.title.split('/')[0]}</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center">${stagesHtml}</div>
                </div>
            `;
            document.getElementById('details-modal').classList.add('is-open');
        }

        window.closeModal = function(modalId) { document.getElementById(modalId).classList.remove('is-open'); }
        window.openModal = openModal;

        // --- HANDLERS DE EVENTOS E AÇÕES ---
        function setupEventListeners() {
            document.getElementById('tabs-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-button')) {
                    currentTab = e.target.id.replace('tab-', '');
                    renderContent(document.getElementById('month-select').value, currentTab);
                }
            });
            document.getElementById('month-select').addEventListener('change', (e) => renderContent(e.target.value, currentTab));
            document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal('delete-confirmation-modal'));
        }

        window.toggleLike = async function(monthId, tab) {
            if (!userId) return;
            const stageId = `${monthId}_${tab}`;
            const likeRef = doc(db, 'likes', stageId);
            try {
                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(likeRef);
                    let { count = 0, likedBy = [] } = docSnap.data() || {};
                    if (likedBy.includes(userId)) {
                        count = Math.max(0, count - 1);
                        likedBy = likedBy.filter(id => id !== userId);
                    } else {
                        count++;
                        likedBy.push(userId);
                    }
                    t.set(likeRef, { count, likedBy });
                });
            } catch (e) { console.error("Erro na transação de like:", e); }
        }

        window.handleCommentSubmit = async function(event, stageId) {
            event.preventDefault();
            const { name, comment } = event.target.elements;
            if (!name.value.trim() || !comment.value.trim() || !userId) return;
            localStorage.setItem('commenterName', name.value);
            try {
                await addDoc(collection(db, 'comments'), {
                    stageId, name: name.value, text: comment.value, likes: 0, likedBy: [], timestamp: serverTimestamp(), authorId: userId
                });
                comment.value = '';
            } catch (error) { console.error("Erro ao adicionar comentário:", error); }
        }
        
        window.toggleCommentLike = async function(commentId) {
             if (!userId) return;
            const commentRef = doc(db, 'comments', commentId);
            try {
                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(commentRef);
                    if (!docSnap.exists()) return;
                    let { likes = 0, likedBy = [] } = docSnap.data();
                    if (likedBy.includes(userId)) {
                        likes = Math.max(0, likes - 1);
                        likedBy = likedBy.filter(id => id !== userId);
                    } else {
                        likes++;
                        likedBy.push(userId);
                    }
                    t.update(commentRef, { likes, likedBy });
                });
            } catch (e) { console.error("Erro ao curtir comentário:", e); }
        }

        window.toggleReplyForm = function(commentId) {
            document.getElementById(`reply-form-container-${commentId}`).classList.toggle('hidden');
        }

        window.handleReplySubmit = async function(event, commentId) {
            event.preventDefault();
            const { name, reply } = event.target.elements;
            if (!name.value.trim() || !reply.value.trim() || !userId) return;
            localStorage.setItem('commenterName', name.value);
            try {
                await addDoc(collection(db, `comments/${commentId}/replies`), {
                    name: name.value, text: reply.value, timestamp: serverTimestamp(), authorId: userId
                });
                reply.value = '';
                toggleReplyForm(commentId);
                loadReplies(commentId);
            } catch (error) { console.error("Erro ao adicionar resposta:", error); }
        }
        
        window.showDeleteConfirmation = function(type, id1, id2 = null) {
            const modal = document.getElementById('delete-confirmation-modal');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = () => {
                if (type === 'comment') deleteComment(id1);
                else if (type === 'reply') deleteReply(id1, id2);
            };
            modal.classList.add('is-open');
        }

        async function deleteComment(commentId) {
            try {
                const repliesSnapshot = await getDocs(collection(db, `comments/${commentId}/replies`));
                const batch = writeBatch(db);
                repliesSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await deleteDoc(doc(db, 'comments', commentId));
            } catch (error) { console.error("Erro ao apagar comentário:", error); }
            finally { closeModal('delete-confirmation-modal'); }
        }

        async function deleteReply(commentId, replyId) {
            try {
                await deleteDoc(doc(db, `comments/${commentId}/replies`, replyId));
                loadReplies(commentId);
            } catch (error) { console.error("Erro ao apagar resposta:", error); }
            finally { closeModal('delete-confirmation-modal'); }
        }

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        async function setupDataListeners() {
            if (!userId) return;
            const reRender = () => {
                const monthSelect = document.getElementById('month-select');
                if (monthSelect.value) {
                    renderContent(monthSelect.value, currentTab);
                }
            }

            onSnapshot(collection(db, 'likes'), (snapshot) => {
                snapshot.docChanges().forEach(change => likesData[change.doc.id] = change.doc.data());
                reRender();
            });

            onSnapshot(collection(db, 'comments'), (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const comment = { id: change.doc.id, ...change.doc.data() };
                    const { stageId } = comment;
                    if (!commentsData[stageId]) commentsData[stageId] = [];
                    const index = commentsData[stageId].findIndex(c => c.id === comment.id);

                    if (change.type === "removed") {
                        if (index > -1) commentsData[stageId].splice(index, 1);
                    } else {
                        if (index > -1) commentsData[stageId][index] = comment;
                        else commentsData[stageId].push(comment);
                    }
                });
                reRender();
            });
        }
        
        async function loadInitialData() {
            try {
                const [pSnap, rSnap, settingsSnap] = await Promise.all([
                    getDocs(collection(db, "participants")), 
                    getDocs(collection(db, "results")),
                    getDoc(doc(db, "settings", "config"))
                ]);
                if (rSnap.empty) return false;

                pSnap.forEach(doc => participantsData[doc.id] = doc.data());
                rSnap.forEach(doc => monthlyData[doc.id] = doc.data());
                
                if (settingsSnap.exists()) {
                    sporadicRiders = settingsSnap.data().sporadicRiders || [];
                }
                
                const monthSelect = document.getElementById('month-select');
                monthSelect.innerHTML = '';
                Object.keys(monthlyData).sort().reverse().forEach(id => {
                    const option = new Option(monthlyData[id].title, id);
                    monthSelect.add(option);
                });
                if (monthSelect.options.length > 0) {
                     monthSelect.selectedIndex = 0;
                }
                return true;
            } catch (e) {
                console.error("Erro ao carregar dados iniciais:", e); throw e;
            }
        }

        async function runApplication() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const showError = (msg) => loadingOverlay.innerHTML = `<p class="text-lg font-semibold text-red-500">${msg}</p>`;
            
            try {
                setupEventListeners();
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log(`User ID: ${userId}`);
                
                if (await loadInitialData()) {
                    const initialMonth = document.getElementById('month-select').value;
                    if (initialMonth) {
                        renderContent(initialMonth, currentTab);
                    }
                    setupDataListeners();
                } else {
                    showError("Nenhum dado encontrado. Verifique as coleções 'results' e 'participants'.");
                }
            } catch (error) {
                console.error("Erro na inicialização:", error);
                showError("Falha ao carregar dados. Verifique a conexão e as regras do Firebase.");
            }
        }

        runApplication();
    </script>
</body>
</html>

