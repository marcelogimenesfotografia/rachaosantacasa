<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Rachão Santa Casa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f4f5;
            --card-bg-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #eab308;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: #f9fafb;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #d99f07; }
        .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .modal { display: none; }
        .modal.is-open { display: flex; }
    </style>
</head>
<body class="antialiased">

    <!-- Tela de Login -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="card w-full max-w-sm">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo" class="w-48 mx-auto mb-6">
            <h2 class="text-2xl font-bold text-center mb-6">Acesso Restrito</h2>
            <form id="login-form" class="space-y-4">
                 <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                    <input type="password" id="password" class="input-field mt-1" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Painel Principal (escondido por padrão) -->
    <div id="dashboard-section" class="hidden max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold">Painel de Administração</h1>
            <button id="logout-btn" class="btn btn-secondary">Sair</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna da Esquerda: Participantes -->
            <div class="lg:col-span-1">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Gerir Participantes</h2>
                    <form id="add-participant-form" class="space-y-3 mb-6">
                        <input id="participant-name" type="text" placeholder="Nome" class="input-field" required>
                        <select id="participant-team" class="input-field"></select>
                        <input id="participant-image" type="url" placeholder="URL da Foto" class="input-field">
                        <button type="submit" class="btn btn-primary w-full">Adicionar Participante</button>
                    </form>
                    <div id="participants-list" class="space-y-2">
                        <!-- Lista de participantes será preenchida aqui -->
                    </div>
                </div>
            </div>

            <!-- Coluna da Direita: Resultados -->
            <div class="lg:col-span-2">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Gerir Resultados</h2>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="month-completed-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                            <span class="font-medium">Mês Concluído (exibir pódio)</span>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-4 items-center mb-6">
                        <select id="month-select-admin" class="input-field flex-grow"></select>
                        <button id="new-month-btn" class="btn btn-secondary">Novo Mês</button>
                    </div>

                    <div id="results-form" class="space-y-6">
                        <!-- Formulários de resultados serão preenchidos aqui -->
                    </div>
                    <div class="mt-6 border-t pt-6">
                         <button id="add-stage-btn" class="btn btn-secondary w-full mb-4">Adicionar Nova Etapa</button>
                         <button id="save-results-btn" class="btn btn-primary w-full">Guardar Alterações do Mês</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Participante -->
    <div id="edit-participant-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-70">
        <div class="card w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Editar Participante</h2>
                <button onclick="closeModal('edit-participant-modal')" class="text-2xl">&times;</button>
            </div>
            <form id="edit-participant-form" class="space-y-3">
                <input type="hidden" id="edit-participant-id">
                <div>
                    <label for="edit-participant-name" class="font-medium">Nome</label>
                    <input id="edit-participant-name" type="text" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="edit-participant-team" class="font-medium">Equipa</label>
                    <select id="edit-participant-team" class="input-field mt-1"></select>
                </div>
                <div>
                    <label for="edit-participant-image" class="font-medium">URL da Foto</label>
                    <input id="edit-participant-image" type="url" class="input-field mt-1">
                </div>
                <div class="pt-2">
                    <label class="flex items-center gap-2">
                         <input type="checkbox" id="edit-participant-sporadic" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                         <span class="font-medium">Marcar como participante esporádico (não pontua)</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                     <button type="button" onclick="closeModal('edit-participant-modal')" class="btn btn-secondary">Cancelar</button>
                     <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, getDocs, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        const firebaseConfig = {
            apiKey: "AIzaSyCWsgx2mSOPwNwWBwl373DJ3oj7VuFwy9Y",
            authDomain: "rachaosc.firebaseapp.com",
            projectId: "rachaosc",
            storageBucket: "rachaosc.appspot.com",
            messagingSenderId: "28309536958",
            appId: "1:28309536958:web:eac51586cdabd82f691eef"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let participantsData = {};
        let monthlyData = {};
        let sporadicRiders = [];
        let allTeams = new Set();

        // --- LÓGICA DE LOGIN ---
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Erro de login:", error.code);
                alert('Email ou palavra-passe incorreta!');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        });

        function showDashboard() {
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            loadAllData();
        }

        function showLogin() {
            loginSection.style.display = 'flex';
            dashboardSection.style.display = 'none';
        }
        
        function openModal(id) { document.getElementById(id).classList.add('is-open'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('is-open'); }

        async function loadAllData() {
            try {
                const [pSnap, rSnap, settingsSnap] = await Promise.all([
                    getDocs(collection(db, "participants")),
                    getDocs(collection(db, "results")),
                    getDoc(doc(db, "settings", "config"))
                ]);
                
                participantsData = {};
                pSnap.forEach(doc => participantsData[doc.id] = doc.data());
                
                monthlyData = {};
                rSnap.forEach(doc => {
                    let data = doc.data();
                    if ((data.etapa1 || data.etapa2 || data.etapa3 || data.etapa4) && !data.stages) {
                        const migratedStages = [];
                        for (let i = 1; i <= 4; i++) {
                            const etapaKey = `etapa${i}`;
                            if (data[etapaKey] && Array.isArray(data[etapaKey]) && data[etapaKey].length > 0) {
                                migratedStages.push({
                                    id: `${etapaKey}_${doc.id}`,
                                    name: `Etapa ${i}`,
                                    date: '',
                                    type: '',
                                    durationDistance: '',
                                    podium_img: data[`${etapaKey}_podium_img`] || '',
                                    results: data[etapaKey]
                                });
                            }
                        }
                        data.stages = migratedStages;
                    }
                    monthlyData[doc.id] = data;
                });

                sporadicRiders = settingsSnap.exists() ? settingsSnap.data().sporadicRiders || [] : [];
                
                allTeams.clear();
                Object.values(participantsData).forEach(p => {
                    if (p.team) allTeams.add(p.team);
                });

                renderParticipants();
                renderMonthSelector();
                renderTeamSelectors();
                
                const initialMonth = document.getElementById('month-select-admin').value;
                if(initialMonth) renderResultsForm(initialMonth);

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                alert("Não foi possível carregar os dados do Firebase. Verifique a consola.");
            }
        }

        function renderTeamSelectors(newTeamToSelect = '') {
            const selects = [document.getElementById('participant-team'), document.getElementById('edit-participant-team')];
            const sortedTeams = [...allTeams].sort();

            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">Selecionar equipa</option>';
                sortedTeams.forEach(team => {
                    select.add(new Option(team, team));
                });
                select.add(new Option("--- Criar nova equipa ---", "new_team"));

                if (newTeamToSelect) {
                    select.value = newTeamToSelect;
                } else if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function handleTeamSelection(selectElementId) {
            const select = document.getElementById(selectElementId);
            if (select.value === 'new_team') {
                const newTeam = prompt("Digite o nome da nova equipa:");
                if (newTeam && newTeam.trim()) {
                    const trimmedTeam = newTeam.trim();
                    allTeams.add(trimmedTeam);
                    renderTeamSelectors(trimmedTeam);
                } else {
                    select.value = '';
                }
            }
        }

        document.getElementById('participant-team').addEventListener('change', () => handleTeamSelection('participant-team'));
        document.getElementById('edit-participant-team').addEventListener('change', () => handleTeamSelection('edit-participant-team'));

        function renderParticipants() {
            const list = document.getElementById('participants-list');
            list.innerHTML = '';
            Object.keys(participantsData).sort().forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                const isSporadic = sporadicRiders.includes(name);
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${name}</span>
                        ${isSporadic ? '<span class="ml-2 text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded-full">ESPORÁDICO</span>' : ''}
                    </div>
                    <div class="space-x-2">
                        <button class="text-blue-500 hover:text-blue-700" data-name="${name}"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500 hover:text-red-700" data-name="${name}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        document.getElementById('add-participant-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('participant-name');
            const name = nameInput.value.trim().toUpperCase();
            if (!name) return;

            const data = {
                team: document.getElementById('participant-team').value.trim(),
                imageUrl: document.getElementById('participant-image').value.trim()
            };
            
            try {
                await setDoc(doc(db, 'participants', name), data);
                alert('Participante adicionado com sucesso!');
                e.target.reset();
                loadAllData();
            } catch (error) {
                console.error("Erro ao adicionar participante:", error);
                alert('Ocorreu um erro.');
            }
        });
        
        document.getElementById('participants-list').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const name = button.dataset.name;

            if (button.querySelector('.fa-edit')) { 
                const data = participantsData[name];
                document.getElementById('edit-participant-id').value = name;
                document.getElementById('edit-participant-name').value = name;
                document.getElementById('edit-participant-team').value = data.team || '';
                document.getElementById('edit-participant-image').value = data.imageUrl || '';
                document.getElementById('edit-participant-sporadic').checked = sporadicRiders.includes(name);
                openModal('edit-participant-modal');
            } else if (button.querySelector('.fa-trash')) {
                if (confirm(`Tem a certeza que deseja apagar ${name}?`)) {
                    deleteParticipant(name);
                }
            }
        });
        
        document.getElementById('edit-participant-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldName = document.getElementById('edit-participant-id').value;
            const newNameInput = document.getElementById('edit-participant-name');
            const newName = newNameInput.value.trim().toUpperCase();
            const isSporadic = document.getElementById('edit-participant-sporadic').checked;

            if (!newName) {
                alert("O nome do participante não pode estar em branco."); return;
            }
            if (newName !== oldName && participantsData[newName]) {
                alert(`Já existe um participante com o nome "${newName}".`); return;
            }

            const participantData = {
                team: document.getElementById('edit-participant-team').value.trim(),
                imageUrl: document.getElementById('edit-participant-image').value.trim()
            };

            if (newName === oldName) {
                try {
                    const settingsRef = doc(db, "settings", "config");
                    const participantRef = doc(db, 'participants', oldName);
                    
                    await setDoc(participantRef, participantData, { merge: true });
                    if(isSporadic) { await updateDoc(settingsRef, { sporadicRiders: arrayUnion(oldName) }); } 
                    else { await updateDoc(settingsRef, { sporadicRiders: arrayRemove(oldName) }); }
                    
                    alert('Participante atualizado!');
                    closeModal('edit-participant-modal');
                    loadAllData();
                } catch (error) { console.error("Erro ao atualizar:", error); alert('Ocorreu um erro.'); }
            } else {
                if (!confirm(`Renomear "${oldName}" para "${newName}"? Esta ação irá atualizar todos os registos de resultados.`)) return;

                try {
                    const batch = writeBatch(db);
                    batch.set(doc(db, 'participants', newName), participantData);
                    batch.delete(doc(db, 'participants', oldName));

                    const settingsRef = doc(db, "settings", "config");
                    if (sporadicRiders.includes(oldName)) {
                        batch.update(settingsRef, { sporadicRiders: arrayRemove(oldName) });
                        if (isSporadic) batch.update(settingsRef, { sporadicRiders: arrayUnion(newName) });
                    } else if (isSporadic) {
                        batch.update(settingsRef, { sporadicRiders: arrayUnion(newName) });
                    }

                    for (const monthId in monthlyData) {
                        const monthDoc = monthlyData[monthId];
                        let monthWasUpdated = false;
                        (monthDoc.stages || []).forEach(stage => {
                            (stage.results || []).forEach(p => {
                                if (p.name === oldName) {
                                    p.name = newName;
                                    monthWasUpdated = true;
                                }
                            });
                        });
                        if (monthWasUpdated) batch.set(doc(db, 'results', monthId), monthDoc);
                    }
                    await batch.commit();
                    alert(`Participante renomeado para "${newName}"!`);
                    closeModal('edit-participant-modal');
                    loadAllData();
                } catch (error) { console.error("Erro ao renomear:", error); alert(`Erro: ${error.message}`); }
            }
        });
        
        async function deleteParticipant(name) {
            try {
                await deleteDoc(doc(db, 'participants', name));
                await updateDoc(doc(db, "settings", "config"), { sporadicRiders: arrayRemove(name) });
                alert('Participante apagado com sucesso!');
                loadAllData();
            } catch (error) { console.error("Erro ao apagar:", error); alert('Ocorreu um erro.'); }
        }
        
        function renderMonthSelector() {
            const select = document.getElementById('month-select-admin');
            select.innerHTML = '';
            const allMonthIds = new Set(Object.keys(monthlyData));
            const currentDate = new Date();
            const currentMonthId = `${currentDate.getFullYear()}_${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            allMonthIds.add(currentMonthId);

            const sortedMonths = [...allMonthIds].sort().reverse();
            
            sortedMonths.forEach(id => {
                const title = monthlyData[id] ? monthlyData[id].title : `${id.split('_')[1]}/${id.split('_')[0]} (Novo)`;
                select.add(new Option(title, id));
            });
            select.value = currentMonthId;
        }

        document.getElementById('month-select-admin').addEventListener('change', (e) => renderResultsForm(e.target.value));

        function createStageFormHTML(stage, index) {
            const stageId = stage.id || `new_stage_${index}`;
            return `
                <div class="stage-form-group border-t-2 border-dashed pt-4" data-stage-id="${stageId}">
                    <div class="flex justify-between items-center mb-2">
                         <h3 class="font-bold text-lg">Etapa ${index + 1}</h3>
                         <button type="button" class="btn-danger text-sm py-1 px-2 remove-stage-btn">Remover</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" placeholder="Nome da Etapa" class="input-field stage-name" value="${stage.name || ''}">
                        <input type="date" class="input-field stage-date" value="${stage.date || ''}">
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                        <select class="input-field stage-type">
                            <option value="">Selecione o tipo</option>
                            <option value="Circuito" ${stage.type === 'Circuito' ? 'selected' : ''}>Circuito</option>
                            <option value="Estrada" ${stage.type === 'Estrada' ? 'selected' : ''}>Estrada</option>
                            <option value="Crono" ${stage.type === 'Crono' ? 'selected' : ''}>Crono</option>
                        </select>
                        <input type="text" placeholder="Duração/Distância" class="input-field stage-duration-distance" value="${stage.durationDistance || ''}">
                    </div>
                    <label class="font-medium text-sm mt-3 block">Participantes (ordem de chegada, separados por vírgula)</label>
                    <textarea class="input-field mt-1 h-24 stage-results">${(stage.results || []).map(p => p.name).join(', ')}</textarea>
                    <label class="font-medium text-sm mt-3 block">URL da Foto do Pódio</label>
                    <input type="url" class="input-field mt-1 stage-podium-img" value="${stage.podium_img || ''}">
                </div>
            `;
        }

        function renderResultsForm(monthId) {
            const container = document.getElementById('results-form');
            if (!monthId || !monthlyData[monthId]) {
                document.getElementById('month-completed-checkbox').checked = false;
                container.innerHTML = '<p class="text-center text-gray-500">Este mês ainda não foi criado. Clique em "Novo Mês" para começar.</p>'; return;
            }
            const data = monthlyData[monthId];
            document.getElementById('month-completed-checkbox').checked = data.isCompleted || false;
            const stages = data.stages || [];
            container.innerHTML = stages.map(createStageFormHTML).join('') || '<p class="text-center text-gray-500">Nenhuma etapa criada para este mês. Adicione uma!</p>';
        }

        document.getElementById('results-form').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-stage-btn')) {
                if (confirm('Tem a certeza que deseja remover esta etapa?')) {
                    e.target.closest('.stage-form-group').remove();
                }
            }
        });

        document.getElementById('add-stage-btn').addEventListener('click', () => {
            const container = document.getElementById('results-form');
            const newIndex = container.querySelectorAll('.stage-form-group').length;
            const newStageHTML = createStageFormHTML({ id: `new_stage_${Date.now()}`}, newIndex);
            
            if(newIndex === 0 && container.querySelector('p')) container.innerHTML = ''; 
            container.insertAdjacentHTML('beforeend', newStageHTML);
        });
        
        document.getElementById('save-results-btn').addEventListener('click', async () => {
            const monthId = document.getElementById('month-select-admin').value;
            if (!monthId) return;

            const docRef = doc(db, 'results', monthId);
            const isCompleted = document.getElementById('month-completed-checkbox').checked;
            const newStages = [];
            
            document.querySelectorAll('#results-form .stage-form-group').forEach(group => {
                const stage = {
                    id: group.dataset.stageId,
                    name: group.querySelector('.stage-name').value.trim(),
                    date: group.querySelector('.stage-date').value,
                    type: group.querySelector('.stage-type').value,
                    durationDistance: group.querySelector('.stage-duration-distance').value.trim(),
                    podium_img: group.querySelector('.stage-podium-img').value.trim(),
                    results: group.querySelector('.stage-results').value.trim().split(',')
                        .map(nameStr => {
                            const name = nameStr.trim().toUpperCase();
                            if (!name) return null;
                            return { 
                                name: name,
                                team: participantsData[name]?.team || '' 
                            };
                        })
                        .filter(p => p)
                };
                newStages.push(stage);
            });
            
            try {
                await updateDoc(docRef, { stages: newStages, isCompleted: isCompleted });
                alert('Resultados guardados com sucesso!');
                loadAllData();
            } catch (error) {
                console.error("Erro ao guardar resultados:", error);
                alert("Ocorreu um erro ao guardar os resultados.");
            }
        });

        function getThursdays(year, month) {
            const thursdays = [];
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                if (date.getDay() === 4) { // Thursday
                    thursdays.push(new Date(date.getTime()));
                }
                date.setDate(date.getDate() + 1);
            }
            return thursdays.map(d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
        }
        
        document.getElementById('new-month-btn').addEventListener('click', async () => {
            const monthId = prompt("Insira um ID para o novo mês NO FORMATO AAAA_MM (ex: 2025_09):");
            if (!monthId || !/^\d{4}_\d{2}$/.test(monthId)) {
                alert("Formato inválido! Utilize o formato AAAA_MM (ex: 2025_09)."); return;
            }
            if (monthlyData[monthId]) {
                alert("Este mês já existe!"); return;
            }

            const monthTitle = prompt("Insira o título para o novo mês (ex: Setembro/2025):");
            if (!monthTitle) return;

            try {
                const [year, month] = monthId.split('_').map(Number);
                const thursdays = getThursdays(year, month);
                
                const newStages = thursdays.map((thursdayDate, index) => ({
                    id: `etapa_${index + 1}_${Date.now()}`,
                    name: `Etapa ${index + 1}`,
                    date: thursdayDate,
                    type: 'Circuito',
                    durationDistance: '55 min + 1 volta',
                    podium_img: '',
                    results: []
                }));

                const newMonthData = { title: monthTitle, stages: newStages, isCompleted: false };
                await setDoc(doc(db, 'results', monthId), newMonthData);
                alert(`Novo mês criado com ${newStages.length} etapas (quintas-feiras)!`);
                
                monthlyData[monthId] = newMonthData;
                renderMonthSelector();
                document.getElementById('month-select-admin').value = monthId;
                renderResultsForm(monthId);

            } catch (error) {
                console.error("Erro ao criar mês:", error);
                alert(`Erro: ${error.message}`);
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) { showDashboard(); } else { showLogin(); }
        });
    </script>
</body>
</html>

